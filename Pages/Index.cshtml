@page "/"
@inject IConfiguration Configuration
@using Azure.Storage.Blobs
@using Azure.Identity
@using System.Text.Json

@{
    ViewData["Title"] = "Home page";

    var containerName = "ibaskantinemenu"; // Replace with your actual container name
    var blobName = "IBASKantineMenu.json"; // Assume the menu data is stored in a JSON blob
    var weekNumber = "Uge N/A";
    var menuItems = new List<dynamic>();

    try
    {
        // Initialize the BlobServiceClient using the managed identity
        var blobServiceClient = new BlobServiceClient(new Uri($"https://ibaskantinemenu.blob.core.windows.net"), new DefaultAzureCredential());
        var blobContainerClient = blobServiceClient.GetBlobContainerClient(containerName);
        var blobClient = blobContainerClient.GetBlobClient(blobName);

        // Read the blob content
        using (var memoryStream = new MemoryStream())
        {
            blobClient.DownloadTo(memoryStream);
            memoryStream.Position = 0; // Reset stream position

            // Deserialize JSON data from blob
            var json = JsonDocument.Parse(memoryStream);
            if (json.RootElement.TryGetProperty("weekNumber", out var weekProperty))
            {
                weekNumber = weekProperty.GetString() ?? "Uge N/A";
            }
            if (json.RootElement.TryGetProperty("menuItems", out var itemsProperty))
            {
                menuItems = JsonSerializer.Deserialize<List<dynamic>>(itemsProperty.GetRawText());
            }
        }
    }
    catch (Exception ex)
    {
        <p>Error reading from Blob Storage: @ex.Message</p>
    }
}

<head>
    <link href="/css/site.css" />
</head>

<div class="text-center">
    <h1 class="display-4">Kantinens Menu for @weekNumber</h1>
    <table border="1" cellpadding="10" cellspacing="0">
        <tr>
            <th>Dag</th>
            <th>Varm Ret</th>
            <th>Kold Ret</th>
        </tr>
        @foreach (var item in menuItems)
        {
            <tr>
                <td>@item["Dag"]</td>
                <td>@item["Varm_ret"]</td>
                <td>@item["Kold_ret"]</td>
            </tr>
        }
    </table>
</div>
